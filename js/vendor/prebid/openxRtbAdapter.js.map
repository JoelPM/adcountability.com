{"version":3,"file":"openxRtbAdapter.js","mappings":"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","sources":["webpack://prebid.js/./modules/openxRtbAdapter.js"],"sourcesContent":["import {config} from '../src/config.js';\nimport {registerBidder} from '../src/adapters/bidderFactory.js';\nimport * as utils from '../src/utils.js';\nimport {BANNER, VIDEO} from '../src/mediaTypes.js';\nimport {includes} from '../src/polyfill.js';\n\nconst bidderConfig = 'hb_pb_ortb';\nconst bidderVersion = '1.0';\nconst VIDEO_TARGETING = ['startdelay', 'mimes', 'minduration', 'maxduration',\n  'startdelay', 'skippable', 'playbackmethod', 'api', 'protocols', 'boxingallowed',\n  'linearity', 'delivery', 'protocol', 'placement', 'minbitrate', 'maxbitrate', 'ext'];\nexport const REQUEST_URL = 'https://rtb.openx.net/openrtbb/prebidjs';\nexport const SYNC_URL = 'https://u.openx.net/w/1.0/pd';\nexport const DEFAULT_PH = '2d1251ae-7f3a-47cf-bd2a-2f288854a0ba';\nexport const spec = {\n  code: 'openx',\n  supportedMediaTypes: [BANNER, VIDEO],\n  isBidRequestValid,\n  buildRequests,\n  interpretResponse,\n  getUserSyncs,\n  transformBidParams\n};\n\nregisterBidder(spec);\n\nfunction transformBidParams(params, isOpenRtb) {\n  return utils.convertTypes({\n    'unit': 'string',\n    'customFloor': 'number'\n  }, params);\n}\n\nfunction isBidRequestValid(bidRequest) {\n  const hasDelDomainOrPlatform = bidRequest.params.delDomain ||\n    bidRequest.params.platform;\n\n  if (utils.deepAccess(bidRequest, 'mediaTypes.banner') &&\n    hasDelDomainOrPlatform) {\n    return !!bidRequest.params.unit ||\n      utils.deepAccess(bidRequest, 'mediaTypes.banner.sizes.length') > 0;\n  }\n\n  return !!(bidRequest.params.unit && hasDelDomainOrPlatform);\n}\n\nfunction buildRequests(bids, bidderRequest) {\n  let videoBids = bids.filter(bid => isVideoBid(bid));\n  let bannerBids = bids.filter(bid => isBannerBid(bid));\n  let requests = bannerBids.length ? [createBannerRequest(bannerBids, bidderRequest)] : [];\n  videoBids.forEach(bid => {\n    requests.push(createVideoRequest(bid, bidderRequest));\n  });\n  return requests;\n}\n\nfunction createBannerRequest(bids, bidderRequest) {\n  let data = getBaseRequest(bids[0], bidderRequest);\n  data.imp = bids.map(bid => {\n    const floor = getFloor(bid, BANNER);\n    let imp = {\n      id: bid.bidId,\n      tagid: bid.params.unit,\n      banner: {\n        format: toFormat(bid.mediaTypes.banner.sizes),\n        topframe: utils.inIframe() ? 0 : 1\n      },\n      ext: {divid: bid.adUnitCode}\n    };\n    enrichImp(imp, bid, floor);\n    return imp;\n  });\n\n  // TODO(joelpm): Probably a better way\n  let qsParams = new URLSearchParams(document.location.search);\n  let traceOwner = qsParams.get(\"to\");\n  let traceID = qsParams.get(\"ti\");\n  if (traceOwner != \"\" && traceID != \"\") {\n    utils.deepSetValue(data, 'ext.trace_owner', traceOwner);\n    utils.deepSetValue(data, 'ext.trace_id', traceID);\n  }\n\n  return {\n    method: 'POST',\n    url: REQUEST_URL,\n    data: data,\n    options: {contentType: 'application/json'}\n  }\n}\n\nfunction toFormat(sizes) {\n  return sizes.map((s) => {\n    return { w: s[0], h: s[1] };\n  });\n}\n\nfunction enrichImp(imp, bid, floor) {\n  if (bid.params.customParams) {\n    utils.deepSetValue(imp, 'ext.customParams', bid.params.customParams);\n  }\n  if (floor > 0) {\n    imp.bidfloor = floor;\n    imp.bidfloorcur = 'USD';\n  } else if (bid.params.customFloor) {\n    imp.bidfloor = bid.params.customFloor;\n  }\n  if (bid.ortb2Imp && bid.ortb2Imp.ext && bid.ortb2Imp.ext.data) {\n    imp.ext.data = bid.ortb2Imp.ext.data;\n  }\n}\n\nfunction enrichFloc(req, bid) {\n  if (bid.userId && bid.userId.flocId) {\n    const flocObject = {\n      id: 'chrome',\n      segment: [{\n        id: 'floc',\n        value: bid.userId.flocId.id.toString(),\n        ext: {\n          ver: bid.userId.flocId.version\n        }\n      }]\n    }\n    if (!req.user) {\n      req.user = {};\n    }\n    if (!req.user.data) {\n      req.user.data = [];\n    }\n    req.user.data.push(flocObject);\n  }\n}\n\nfunction createVideoRequest(bid, bidderRequest) {\n  let width;\n  let height;\n  const videoMediaType = utils.deepAccess(bid, `mediaTypes.video`);\n  const playerSize = utils.deepAccess(bid, 'mediaTypes.video.playerSize');\n  const context = utils.deepAccess(bid, 'mediaTypes.video.context');\n  const floor = getFloor(bid, VIDEO);\n\n  // normalize config for video size\n  if (utils.isArray(bid.sizes) && bid.sizes.length === 2 && !utils.isArray(bid.sizes[0])) {\n    width = parseInt(bid.sizes[0], 10);\n    height = parseInt(bid.sizes[1], 10);\n  } else if (utils.isArray(bid.sizes) && utils.isArray(bid.sizes[0]) && bid.sizes[0].length === 2) {\n    width = parseInt(bid.sizes[0][0], 10);\n    height = parseInt(bid.sizes[0][1], 10);\n  } else if (utils.isArray(playerSize) && playerSize.length === 2) {\n    width = parseInt(playerSize[0], 10);\n    height = parseInt(playerSize[1], 10);\n  }\n\n  let data = getBaseRequest(bid, bidderRequest);\n  data.imp = [{\n    id: bid.bidId,\n    tagid: bid.params.unit,\n    video: {\n      w: width,\n      h: height,\n      topframe: utils.inIframe() ? 0 : 1\n    },\n    ext: {divid: bid.adUnitCode}\n  }];\n\n  enrichImp(data.imp[0], bid, floor);\n\n  if (context) {\n    if (context === 'instream') {\n      data.imp[0].video.placement = 1;\n    } else if (context === 'outstream') {\n      data.imp[0].video.placement = 4;\n    }\n  }\n\n  let videoParams = bid.params.video || bid.params.openrtb || {};\n  if (utils.isArray(videoParams.imp)) {\n    videoParams = videoParams[0].video;\n  }\n\n  Object.keys(videoParams)\n    .filter(param => includes(VIDEO_TARGETING, param))\n    .forEach(param => data.imp[0].video[param] = videoParams[param]);\n  Object.keys(videoMediaType)\n    .filter(param => includes(VIDEO_TARGETING, param))\n    .forEach(param => data.imp[0].video[param] = videoMediaType[param]);\n\n  return {\n    method: 'POST',\n    url: REQUEST_URL,\n    data: data,\n    options: {contentType: 'application/json'}\n  }\n}\n\nfunction getBaseRequest(bid, bidderRequest) {\n  let req = {\n    id: bidderRequest.auctionId,\n    cur: [config.getConfig('currency.adServerCurrency') || 'USD'],\n    at: 1,\n    tmax: config.getConfig('bidderTimeout'),\n    site: {\n      page: config.getConfig('pageUrl') || bidderRequest.refererInfo.referer\n    },\n    regs: {\n      coppa: (config.getConfig('coppa') === true || bid.params.coppa) ? 1 : 0,\n    },\n    device: {\n      dnt: (utils.getDNT() || bid.params.doNotTrack) ? 1 : 0,\n      h: screen.height,\n      w: screen.width,\n      ua: window.navigator.userAgent,\n      language: window.navigator.language.split('-').shift()\n    },\n    ext: {\n      bc: bid.params.bc || `${bidderConfig}_${bidderVersion}`\n    }\n  };\n\n  if (bid.params.platform) {\n    utils.deepSetValue(req, 'ext.platform', bid.params.platform);\n  }\n  if (bid.params.delDomain) {\n    utils.deepSetValue(req, 'ext.delDomain', bid.params.delDomain);\n  }\n  if (bid.params.test) {\n    req.test = 1\n  }\n  if (bidderRequest.gdprConsent) {\n    if (bidderRequest.gdprConsent.gdprApplies !== undefined) {\n      utils.deepSetValue(req, 'regs.ext.gdpr', bidderRequest.gdprConsent.gdprApplies === true ? 1 : 0);\n    }\n    if (bidderRequest.gdprConsent.consentString !== undefined) {\n      utils.deepSetValue(req, 'user.ext.consent', bidderRequest.gdprConsent.consentString);\n    }\n    if (bidderRequest.gdprConsent.addtlConsent !== undefined) {\n      utils.deepSetValue(req, 'user.ext.ConsentedProvidersSettings.consented_providers', bidderRequest.gdprConsent.addtlConsent);\n    }\n  }\n  if (bidderRequest.uspConsent) {\n    utils.deepSetValue(req, 'regs.ext.us_privacy', bidderRequest.uspConsent);\n  }\n  if (bid.schain) {\n    utils.deepSetValue(req, 'source.ext.schain', bid.schain);\n  }\n  if (bid.userIdAsEids) {\n    utils.deepSetValue(req, 'user.ext.eids', bid.userIdAsEids);\n  }\n  const commonFpd = config.getConfig('ortb2') || {};\n  if (commonFpd.site) {\n    utils.mergeDeep(req, {site: commonFpd.site});\n  }\n  if (commonFpd.user) {\n    utils.mergeDeep(req, {user: commonFpd.user});\n  }\n  enrichFloc(req, bid)\n  return req;\n}\n\nfunction isVideoBid(bid) {\n  return utils.deepAccess(bid, 'mediaTypes.video');\n}\n\nfunction isBannerBid(bid) {\n  return utils.deepAccess(bid, 'mediaTypes.banner') || !isVideoBid(bid);\n}\n\nfunction getFloor(bid, mediaType) {\n  let floor = 0;\n\n  if (typeof bid.getFloor === 'function') {\n    const floorInfo = bid.getFloor({\n      currency: 'USD',\n      mediaType: mediaType,\n      size: '*'\n    });\n\n    if (typeof floorInfo === 'object' &&\n      floorInfo.currency === 'USD' &&\n      !isNaN(parseFloat(floorInfo.floor))) {\n      floor = Math.max(floor, parseFloat(floorInfo.floor));\n    }\n  }\n\n  return floor;\n}\n\nfunction interpretResponse(resp, req) {\n  // pass these from request to the responses for use in userSync\n  if (req.data.ext) {\n    if (req.data.ext.delDomain) {\n      utils.deepSetValue(resp, 'body.ext.delDomain', req.data.ext.delDomain);\n    }\n    if (req.data.ext.platform) {\n      utils.deepSetValue(resp, 'body.ext.platform', req.data.ext.platform);\n    }\n  }\n\n  const respBody = resp.body;\n  if ('nbr' in respBody) {\n    return [];\n  }\n\n  let bids = [];\n  respBody.seatbid.forEach(seatbid => {\n    bids = [...bids, ...seatbid.bid.map(bid => {\n      let response = {\n        requestId: bid.impid,\n        cpm: bid.price,\n        width: bid.w,\n        height: bid.h,\n        creativeId: bid.crid,\n        dealId: bid.dealid,\n        currency: respBody.cur || 'USD',\n        netRevenue: true,\n        ttl: 300,\n        mediaType: 'banner' in req.data.imp[0] ? BANNER : VIDEO,\n        meta: { advertiserDomains: bid.adomain }\n      };\n\n      if (response.mediaType === VIDEO) {\n        if (bid.nurl) {\n          response.vastUrl = bid.nurl;\n        } else {\n          response.vastXml = bid.adm;\n        }\n      } else {\n        response.ad = bid.adm;\n      }\n\n      if (bid.ext) {\n        response.meta.networkId = bid.ext.dsp_id;\n        response.meta.advertiserId = bid.ext.buyer_id;\n        response.meta.brandId = bid.ext.brand_id;\n      }\n      return response\n    })];\n  });\n\n  return bids;\n}\n\n/**\n * @param syncOptions\n * @param responses\n * @param gdprConsent\n * @param uspConsent\n * @return {{type: (string), url: (*|string)}[]}\n */\nfunction getUserSyncs(syncOptions, responses, gdprConsent, uspConsent) {\n  if (syncOptions.iframeEnabled || syncOptions.pixelEnabled) {\n    let pixelType = syncOptions.iframeEnabled ? 'iframe' : 'image';\n    let queryParamStrings = [];\n    let syncUrl = SYNC_URL;\n    if (gdprConsent) {\n      queryParamStrings.push('gdpr=' + (gdprConsent.gdprApplies ? 1 : 0));\n      queryParamStrings.push('gdpr_consent=' + encodeURIComponent(gdprConsent.consentString || ''));\n    }\n    if (uspConsent) {\n      queryParamStrings.push('us_privacy=' + encodeURIComponent(uspConsent));\n    }\n    if (responses.length > 0 && responses[0].body && responses[0].body.ext) {\n      const ext = responses[0].body.ext;\n      if (ext.delDomain) {\n        syncUrl = `https://${ext.delDomain}/w/1.0/pd`\n      } else if (ext.platform) {\n        queryParamStrings.push('ph=' + ext.platform)\n      }\n    } else {\n      queryParamStrings.push('ph=' + DEFAULT_PH)\n    }\n    return [{\n      type: pixelType,\n      url: `${syncUrl}${queryParamStrings.length > 0 ? '?' + queryParamStrings.join('&') : ''}`\n    }];\n  }\n}\n"],"names":["VIDEO_TARGETING","REQUEST_URL","spec","code","supportedMediaTypes","BANNER","VIDEO","isBidRequestValid","bidRequest","hasDelDomainOrPlatform","params","delDomain","platform","utils","unit","buildRequests","bids","bidderRequest","videoBids","filter","bid","isVideoBid","bannerBids","isBannerBid","requests","length","createBannerRequest","forEach","push","width","height","videoMediaType","playerSize","context","floor","getFloor","sizes","parseInt","data","getBaseRequest","imp","id","bidId","tagid","video","w","h","topframe","ext","divid","adUnitCode","enrichImp","placement","videoParams","openrtb","Object","keys","param","includes","method","url","options","contentType","createVideoRequest","interpretResponse","resp","req","respBody","body","seatbid","map","response","requestId","impid","cpm","price","creativeId","crid","dealId","dealid","currency","cur","netRevenue","ttl","mediaType","meta","advertiserDomains","adomain","nurl","vastUrl","vastXml","adm","ad","networkId","dsp_id","advertiserId","buyer_id","brandId","brand_id","getUserSyncs","syncOptions","responses","gdprConsent","uspConsent","iframeEnabled","pixelEnabled","pixelType","queryParamStrings","syncUrl","gdprApplies","encodeURIComponent","consentString","type","join","transformBidParams","isOpenRtb","banner","format","mediaTypes","s","qsParams","URLSearchParams","document","location","search","traceOwner","get","traceID","customParams","bidfloor","bidfloorcur","customFloor","ortb2Imp","auctionId","config","at","tmax","site","page","refererInfo","referer","regs","coppa","device","dnt","doNotTrack","screen","ua","window","navigator","userAgent","language","split","shift","bc","test","undefined","addtlConsent","schain","userIdAsEids","commonFpd","user","userId","flocId","flocObject","segment","value","toString","ver","version","enrichFloc","floorInfo","size","isNaN","parseFloat","Math","max","registerBidder","pbjs","installedModules"],"sourceRoot":""}